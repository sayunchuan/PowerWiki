name: Sync Upstream and Build Docker

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时执行（UTC时间）
  workflow_dispatch:        # 支持手动触发

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync from upstream
        id: sync
        run: |
          # 添加源仓库
          git remote add upstream https://github.com/steven-ld/PowerWiki.git || true
          git fetch upstream
          
          # 检查是否有新的提交
          LOCAL=$(git rev-parse HEAD)
          UPSTREAM=$(git rev-parse upstream/master)
          BASE=$(git merge-base HEAD upstream/master)
          
          if [ "$LOCAL" = "$UPSTREAM" ]; then
            echo "已是最新，无需同步"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          elif [ "$BASE" = "$UPSTREAM" ]; then
            echo "本地领先于 upstream，无需同步"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "发现更新，开始合并..."
            # 使用 -X theirs 策略：冲突时优先使用 upstream 版本
            git merge upstream/master -X theirs -m "chore: sync with upstream"
            git push origin master
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/powerwiki:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/powerwiki:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
